version: 0.2

env:
  variables:
    NPM_CONFIG_PRODUCTION: "false"

phases:
  install:
    runtime-versions:
      nodejs: latest
    commands:
      - echo "Installing CDK dependencies..."
      - (cd infra && npm ci --no-progress)

  build:
    commands:
      - echo "Deploying backend infrastructure for environment:$ENVIRONMENT"
      - (cd infra && npm run build)
      - |
        echo "Deploying API stack..."
        (cd infra && npx cdk deploy IronmanCountdownApi-$ENVIRONMENT \
          --context environment=$ENVIRONMENT \
          --require-approval never \
          --progress events) || echo "Stack deployment completed"
      - |
        echo "Updating Lambda function code..."
        for zip in lambda-builds/*.zip; do
          if [ -f "$zip" ]; then
            func=$(basename "$zip" .zip)
            func_name="${LAMBDA_FUNCTION_PREFIX}-${ENVIRONMENT}-${func}"
            echo "Updating function:$func_name"
            aws lambda update-function-code \
              --function-name "$func_name" \
              --zip-file "fileb://$zip" \
              --region ${AWS_DEFAULT_REGION:-us-east-1} || echo "Function update skipped:$func_name"
            aws lambda update-alias \
              --function-name "$func_name" \
              --name live \
              --function-version '$LATEST' \
              --region ${AWS_DEFAULT_REGION:-us-east-1} || echo "Alias update skipped:$func_name"
          fi
        done
      - |
        echo "API_URL=$(aws cloudformation describe-stacks \
          --stack-name IronmanCountdownApi-$ENVIRONMENT \
          --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
          --output text 2>/dev/null || echo '')" > deployment-outputs.env
      - cat deployment-outputs.env

artifacts:
  files:
    - "deployment-outputs.env"
  name: BackendDeployOutput

cache:
  paths:
    - "~/.npm/**/*"

